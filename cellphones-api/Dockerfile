# ===============================================
# üêò Laravel 12.x - Render Optimized Dockerfile
# ===============================================
FROM php:8.2-apache

# 1Ô∏è‚É£ Install PHP extensions
RUN apt-get update && apt-get install -y \
    git curl zip unzip libpng-dev libonig-dev libxml2-dev libzip-dev sqlite3 libsqlite3-dev \
    && docker-php-ext-install pdo pdo_mysql pdo_sqlite mbstring exif pcntl bcmath gd zip \
    && a2enmod rewrite

# ‚öôÔ∏è Fix Apache ServerName warning (AH00558)
RUN echo "ServerName localhost" >> /etc/apache2/apache2.conf

# 2Ô∏è‚É£ Set working directory
WORKDIR /var/www/html

# 3Ô∏è‚É£ Copy composer files first (for layer caching)
COPY composer.json composer.lock ./

# 4Ô∏è‚É£ Install composer dependencies (cached layer)
COPY --from=composer:2 /usr/bin/composer /usr/bin/composer
RUN composer install --no-dev --prefer-dist --optimize-autoloader \
 && composer dump-autoload -o

# 5Ô∏è‚É£ Copy project files
COPY . .

# 6Ô∏è‚É£ Prepare SQLite
RUN mkdir -p database && touch database/database.sqlite && chmod 777 database/database.sqlite

# 7Ô∏è‚É£ Copy .env if missing
RUN if [ ! -f ".env" ]; then cp .env.example .env; fi

# 8Ô∏è‚É£ Generate key & cache config
RUN php artisan key:generate || true \
 && php artisan config:clear && php artisan cache:clear && php artisan route:clear && php artisan view:clear \
 && php artisan config:cache && php artisan route:cache && php artisan view:cache

# ‚úÖ Apache serve /public
RUN sed -i 's|/var/www/html|/var/www/html/public|g' /etc/apache2/sites-available/000-default.conf

# 9Ô∏è‚É£ Render port
EXPOSE 10000
ENV PORT=10000
RUN sed -i "s/80/${PORT}/g" /etc/apache2/sites-available/000-default.conf /etc/apache2/ports.conf

# üîü Auto migrate + seed at startup
CMD php artisan migrate:fresh --seed --force && apache2-foreground

# ü©∫ Healthcheck
HEALTHCHECK CMD curl -f http://localhost:10000/api/v1/products || exit 1
